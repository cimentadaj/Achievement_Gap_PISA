perc_teacher_trained <- wd_extract("UIS.TRTP.0", "perc_teach")
preprimary_priv_enrol <- wd_extract("SE.PRE.PRIV.ZS", "preprimary_priv_enrol")
tracking_data <-
readxl::read_xlsx("./paper/data/tracking.xlsx", sheet = "all_data") %>%
map_if(is_double, round, 2) %>%
as_tibble
difference_data <-
complete_data_topbottom %>%
filter(type_test == "math") %>%
select(wave, country, difference) %>%
rename(year = wave) %>%
mutate(year = as.character(year))
library(inequalityintsvy)
central_examination <-
tribble(
~ country, ~central_examination,
"Australia", 1,
"Austria", 0,
"Belgium", 0,
"Bulgaria", 1,
"Canada", rbinom(1, 1, prob = 0.51),
"Czech Republic", 1,
"Denmark", 1,
"Finland", 1,
"France", 1,
"Germany", 0,
"United Kingdom", 1,
"Greece", 0,
"Hong Kong", 1,
"Hungary", 1,
"Iceland", 1,
"Ireland", 1,
"Israel", 1,
"Italy", 1,
"Japan", 1,
"Korea", 1,
"Latvia", 1,
"Liechtenstein", 1,
"Luxembourg", 1,
"Netherlands", 1,
"New Zealand", 1,
"Norway", 1,
"Poland", 1,
"Portugal", 0,
"Russia", 1,
"Slovakia", 1,
"Slovenia", 1,
"Spain", 0,
"Sweden", 0,
"Switzerland", 0,
"Turkey", 1,
"United States", 1
)
# The tracking variables explain very nicely the difference in test scores
# for all countries pooled, up to 50% R squared.
ready_data <-
difference_data %>%
left_join(tracking_data, by = c("country" = "cntry_name")) %>%
left_join(central_examination) %>%
mutate(num_tracks = ifelse(tracks15y == 1, 1, 0) %>% as.factor,
age_selection = ifelse(selage >= 15, 1, 0)) %>%
filter(!is.na(num_tracks), !is.na(age_selection), !is.na(difference))
library(brms)
mod_tracking <-
brms::brm(
difference ~
num_tracks +
age_selection + (1 | country),
family = gaussian(),
data = ready_data,
prior = c(set_prior("cauchy(2, 0.5)", coef = "num_tracks1"),
set_prior("cauchy(13, 1)", coef = "age_selection")
),
warmup = 1000, iter = 2000, chains = 5
)
mod_tracking
new_data <-
ready_data %>%
filter(country %in% countries) %>%
expand(country, age_selection, num_tracks) %>%
filter(complete.cases(.))
predictions <- posterior_predict(mod_tracking, newdata = new_data)
sd_obs <- colSds(predictions)
new_data <-
new_data %>%
mutate(
pred = colMeans(predictions),
pred_low = pred - (2 * sd_obs),
pred_high = pred + (2 * sd_obs)
)
sum_ready_data <-
ready_data %>%
group_by(country, num_tracks, age_selection) %>%
summarize(avg_diff = mean(difference),
diff_low = avg_diff - 2 * sd(difference),
diff_high = avg_diff + 2 * sd(difference)) %>%
ungroup()
new_data %>%
left_join(sum_ready_data) %>%
filter(country %in% countries) %>%
ggplot(aes(num_tracks %>% as.factor, avg_diff, fill = num_tracks)) +
geom_errorbar(aes(ymin = diff_low, ymax = diff_high), width = 0.2, colour = "red") +
geom_point(colour = "red") +
scale_y_continuous(limits = c(0, 4)) +
geom_col(aes(y = pred, alpha = 0.4)) +
geom_errorbar(aes(ymin = pred_low, ymax = pred_high), width = 0.2) +
facet_wrap(country ~ age_selection) +
scale_fill_wsj()
y_rep <- posterior_predict(mod_tracking)
replication <-
map(1:2000, ~ {
ready_data %>%
mutate(pred_sample = y_rep[sample(1:4000, 1), , drop = TRUE]) %>%
summarize(perc_sample = mean(pred_sample > difference),
minus_sample = mean(pred_sample - difference))
})
replication %>%
enframe() %>%
unnest() %>%
qplot(minus_sample, geom = "histogram", data = .)
replication %>%
enframe() %>%
unnest() %>%
summarize(mean(between(minus_sample, -0.05, 0.05)))
replication %>%
enframe() %>%
unnest() %>%
summarize(mean(between(perc_sample, 0.45, 0.55)))
replication %>%
enframe() %>%
unnest()
replication %>%
enframe() %>%
unnest() %>%
summarize(mean(between(perc_sample, 0.45, 0.55)))
replication %>%
enframe() %>%
unnest() %>%
summarize(mean(between(perc_sample, 0.45, 0.55)))
replication %>%
enframe() %>%
unnest() %>%
qplot(perc_sample, geom = "histogram", data = .)
replication %>%
enframe() %>%
unnest() %>%
summarize(mean(between(perc_sample > 0.5)))
replication %>%
enframe() %>%
unnest() %>%
summarize(mean(perc_sample > 0.5))
replication %>%
enframe() %>%
unnest() %>%
summarize(mean(perc_sample < 0.5))
replication %>%
enframe() %>%
unnest() %>%
summarize(mean(perc_sample < 0.5))
pp_check(mod_tracking, nsamples = 100)
ready_data %>%
group_by(country)
?summarise_at
ready_data %>%
group_by(country) %>%
summarize(
summarize_at(vars(c("length", "num_tracks", "age_selection", "central_examination", "avg_track")),
unique))
vars(c("length", "num_tracks", "age_selection", "central_examination", "avg_track"))
ready_data %>%
group_by(country) %>%
summarize_at(vars(c("length", "num_tracks", "age_selection", "central_examination", "avg_track")),
unique)
ready_data %>%
group_by(country) %>%
summarize_at(vars(c("length", "num_tracks", "age_selection", "central_examination", "ztrack")),
unique)
vars_unique <- c("length", "num_tracks", "age_selection", "central_examination", "ztrack")
ready_data %>%
group_by(country) %>%
summarize_at(vars(vars_unique), unique)
ready_data %>%
group_by(country) %>%
summarize_at(vars(vars_unique), unique) %>%
mutate(cum_sum = ready_data %>% group_by(country) %>% pull(sum(difference, na.rm = T)))
ready_data %>%
group_by(country)
ready_data %>%
group_by(country)
ready_data %>% group_by(country) %>% pull(sum(difference, na.rm = T))
pull
ready_data %>%
group_by(country) %>%
summarize_at(vars(vars_unique), unique) %>%
mutate(cum_sum = ready_data %>% group_by(country) %>% summarize(m, sum(difference)) %>% pull(m))
ready_data %>% group_by(country) %>% summarize(m, sum(difference)) %>% pull(m)
ready_data %>% group_by(country) %>% summarize(m = sum(difference)) %>% pull(m)
ready_data %>%
group_by(country) %>%
summarize_at(vars(vars_unique), unique) %>%
mutate(cum_sum = ready_data %>% group_by(country) %>% summarize(m = sum(difference)) %>% pull(m))
ready_data_two <-
ready_data %>%
group_by(country) %>%
summarize_at(vars(vars_unique), unique) %>%
mutate(cum_sum = ready_data %>% group_by(country) %>% summarize(m = sum(difference)) %>% pull(m))
mod_tracking <-
ready_data_two %>%
filter(!is.na(age_selection)) %>%
stan_glm(cum_diff ~ age_selection, data = .,
family = "gaussian",
prior = normal(0, 2),
prior_intercept = normal(0, 5),
prior_aux = cauchy(0, 1),
refresh = -1)
ready_data_two <-
ready_data %>%
group_by(country) %>%
summarize_at(vars(vars_unique), unique) %>%
mutate(cum_diff = ready_data %>% group_by(country) %>% summarize(m = sum(difference)) %>% pull(m))
mod_tracking <-
ready_data_two %>%
filter(!is.na(age_selection)) %>%
stan_glm(cum_diff ~ age_selection, data = .,
family = "gaussian",
prior = normal(0, 2),
prior_intercept = normal(0, 5),
prior_aux = cauchy(0, 1),
refresh = -1)
ready_data_two %>%
filter(!is.na(age_selection)) %>%
mutate(pred_mean = posterior_predict(mod_tracking) %>% colMeans(),
pred_median = posterior_predict(mod_tracking) %>% colMedians()) %>%
select(country, cum_diff, pred_mean, pred_median) %>%
gather(cat, value, -country) %>%
ggplot(aes(country, value, fill = cat)) +
geom_col(position = "dodge") +
coord_flip()
ready_data_two %>%
filter(!is.na(age_selection))
pp_check(mod_tracking, nreps = 100)
pp_check(mod_tracking, nreps = 1000)
pp_check(mod_tracking, nreps = 1000)
pp_check(mod_tracking, nreps = 500)
y_rep <- posterior_predict(mod_tracking)
y_rep %>% dim
replication <-
map(1:2000, ~ {
ready_data_two %>%
mutate(pred_sample = y_rep[sample(1:4000, 1), , drop = TRUE]) %>%
summarize(perc_sample = mean(pred_sample > difference),
minus_sample = mean(pred_sample - difference))
})
replication <-
map(1:2000, ~ {
ready_data_two %>%
mutate(pred_sample = y_rep[sample(1:4000, 1), , drop = TRUE]) %>%
summarize(perc_sample = mean(pred_sample > cum_diff),
minus_sample = mean(pred_sample - cum_diff))
})
replicaton[[1]]
replication[[1]]
replication %>%
enframe() %>%
unnest()
replication %>%
enframe() %>%
unnest() %>%
qplot(perc_sample, data = ., geom = "histogram")
replication %>%
enframe() %>%
unnest() %>%
qplot(perc_sample, data = ., geom = "histogram", bins = 50)
y_pred_data <-
replication %>%
enframe() %>%
unnest()
y_pred_data %>%
qplot(perc_sample, data = ., geom = "histogram", bins = 50)
y_pred_data %>%
summarize(mean_perc = mean(perc_sample, na.rm = TRUE),
median_perc = median(perc_sample, na.rm = TRUE))
y_pred_data %>%
summarize(mean_perc = mean(perc_sample, na.rm = TRUE))
y_pred_data %>%
qplot(perc_sample, data = ., geom = "density", bins = 50)
y_pred_data %>% do(quantile(perc_sample))
y_pred_data %>% do(quantile(.$perc_sample))
y_pred_data %>% quantile(.$perc_sample)
y_pred_data
?quantile
y_pred_data %>% {quantile(.$perc_sample)}
mod_tracking <-
ready_data_two %>%
filter(!is.na(age_selection)) %>%
brm(
cum_diff ~ age_selection,
family = gaussian(),
data = .,
prior = set_prior("cauchy(13, 1)", coef = "age_selection"),
warmup = 1000, iter = 2000, chains = 5
)
pp_check(mod_tracking, nreps = 500)
pp_check(mod_tracking, nsamples = 500)
pp_check(mod_tracking, nsamples = 100)
y_rep <- posterior_predict(mod_tracking)
replication <-
map(1:2000, ~ {
ready_data_two %>%
mutate(pred_sample = y_rep[sample(1:4000, 1), , drop = TRUE]) %>%
summarize(perc_sample = mean(pred_sample > cum_diff),
minus_sample = mean(pred_sample - cum_diff))
})
y_pred_data <-
replication %>%
enframe() %>%
unnest()
y_pred_data %>% qplot(perc_sample, data = ., geom = "density", bins = 50)
y_pred_data %>% qplot(perc_sample, data = ., geom = "histogram", bins = 50)
y_pred_data %>% {quantile(.$perc_sample)}
y_pred_data
y_pred_data %>%
summarize(mean_perc = mean(perc_sample > 0.5))
y_pred_data %>%
summarize(mean_perc = mean(perc_sample < 0.5))
46 + 38
y_pred_data %>%
summarize(mean_perc = mean(perc_sample =< 0.5))
y_pred_data %>%
summarize(mean_perc = mean(perc_sample <= 0.5))
y_pred_data %>%
summarize(mean_perc = mean(perc_sample == 0.5))
y_pred_data %>%
summarize(mean_perc = mean(perc_sample < 0.5))
y_pred_data %>%
summarize(mean_perc = mean(between(perc_sample, 0.45, 0.55)))
y_pred_data %>%
summarize(mean_perc = mean(between(perc_sample, 0.45, 0.55)))
y_pred_data %>%
summarize(mean_perc = mean(between(perc_sample, 0.1, 0.4)))
y_pred_data %>%
summarize(mean_perc = mean(between(perc_sample, 0.6, 0.9)))
y_pred_data %>%
summarize(mean_perc = mean(perc_sample > 0.5))
y_pred_data %>%
summarize(mean_perc = mean(perc_sample < 0.5))
mod_tracking
?brm
WAIC(mod_tracking)
mod_tracking <-
ready_data_two %>%
filter(!is.na(age_selection)) %>%
brm(
cum_diff ~,
family = gaussian(),
data = .,
prior = set_prior("cauchy(13, 1)", coef = "age_selection"),
warmup = 1000, iter = 2000, chains = 5
)
mod_tracking <-
ready_data_two %>%
filter(!is.na(age_selection)) %>%
brm(
cum_diff ~ 1,
family = gaussian(),
data = .,
prior = set_prior("cauchy(13, 1)", coef = "age_selection"),
warmup = 1000, iter = 2000, chains = 5
)
mod_tracking <-
ready_data_two %>%
filter(!is.na(age_selection)) %>%
brm(
cum_diff ~ age_selection,
family = gaussian(),
data = .,
prior = set_prior("cauchy(13, 1)", coef = "age_selection"),
warmup = 1000, iter = 2000, chains = 5
)
class(mod_tracking)
bayes_R2(mod_tracking)
mod_tracking <-
ready_data_two %>%
lm(cum_diff ~ age_selection, data = .)
mod_tracking
arm::display(mod_tracking)
ready_data_two
ready_data_two %>%
lm(cum_diff ~ num_tracks, data = .) %>%
arm::display()
ready_data_two %>%
lm(cum_diff ~ num_tracks + age_selection, data = .) %>%
arm::display()
mod_tracking <-
ready_data_two %>%
filter(!is.na(age_selection)) %>%
brm(
cum_diff ~ age_selection + num_tracks,
family = gaussian(),
data = .,
prior = set_prior("cauchy(13, 1)", coef = "age_selection"),
warmup = 1000, iter = 2000, chains = 5
)
install.packages("devtools")
devtools::install_github("iobis/robis")
library(robis)
unloadNamespace("robis")
x <- array(1:9,c(3,3))
x
apply(x, 1, function(x) x * 10)
x
x * 10
x + 1
apply
x * 10
x
apply(x, function(x) x*10)
apply(x, 1, function(x) x*10)
x
?apply
mod_tracking
bayes_R2(mod_tracking)
pp_check(mod_tracking, nsamples = 100)
y_rep <- posterior_predict(mod_tracking)
replication <-
map(1:2000, ~ {
ready_data_two %>%
mutate(pred_sample = y_rep[sample(1:4000, 1), , drop = TRUE]) %>%
summarize(perc_sample = mean(pred_sample > cum_diff),
minus_sample = mean(pred_sample - cum_diff))
})
y_pred_data <-
replication %>%
enframe() %>%
unnest()
y_pred_data %>% qplot(perc_sample, data = ., geom = "histogram", bins = 50)
y_pred_data %>% {quantile(.$perc_sample)}
y_pred_data %>%
summarize(mean_perc = mean(perc_sample < 0.5))
mod_tracking <-
ready_data_two %>%
filter(!is.na(age_selection)) %>%
brm(
cum_diff ~ age_selection,
family = gaussian(),
data = .,
prior = set_prior("cauchy(13, 1)", coef = "age_selection"),
warmup = 1000, iter = 2000, chains = 5
)
pp_check(mod_tracking, nsamples = 100)
y_rep <- posterior_predict(mod_tracking)
replication <-
map(1:2000, ~ {
ready_data_two %>%
mutate(pred_sample = y_rep[sample(1:4000, 1), , drop = TRUE]) %>%
summarize(perc_sample = mean(pred_sample > cum_diff),
minus_sample = mean(pred_sample - cum_diff))
})
y_pred_data <-
replication %>%
enframe() %>%
unnest()
y_pred_data %>% qplot(perc_sample, data = ., geom = "histogram", bins = 50)
y_pred_data %>% {quantile(.$perc_sample)}
y_pred_data %>%
summarize(mean_perc = mean(perc_sample < 0.5))
bayes_R2(mod_tracking)
ready_data_two %>%
filter(!is.na(age_selection)) %>%
mutate(pred_mean = posterior_predict(mod_tracking) %>% colMeans(),
pred_median = posterior_predict(mod_tracking) %>% colMedians()) %>%
select(country, cum_diff, pred_mean, pred_median) %>%
gather(cat, value, -country) %>%
ggplot(aes(country, value, fill = cat)) +
geom_col(position = "dodge") +
coord_flip()
ready_data_two %>%
filter(!is.na(age_selection)) %>%
mutate(pred_median = posterior_predict(mod_tracking) %>% colMedians()) %>%
select(country, cum_diff, pred_mean, pred_median) %>%
gather(cat, value, -country) %>%
ggplot(aes(country, value, fill = cat)) +
geom_col(position = "dodge") +
coord_flip()
ready_data_two %>%
filter(!is.na(age_selection)) %>%
mutate(pred_median = posterior_predict(mod_tracking) %>% colMedians()) %>%
select(country, cum_diff, pred_median) %>%
gather(cat, value, -country) %>%
ggplot(aes(country, value, fill = cat)) +
geom_col(position = "dodge") +
coord_flip()
ready_data_two %>%
filter(!is.na(age_selection)) %>%
mutate(pred_median = posterior_predict(mod_tracking) %>% colMedians()) %>%
select(country, cum_diff, pred_median) %>%
gather(cat, value, -country)
ready_data_two %>%
filter(!is.na(age_selection)) %>%
mutate(pred_median = posterior_predict(mod_tracking) %>% colMedians()) %>%
select(country, cum_diff, pred_median)
m <- ready_data_two %>%
filter(!is.na(age_selection)) %>%
mutate(pred_median = posterior_predict(mod_tracking) %>% colMedians()) %>%
select(country, cum_diff, pred_median)
m %>% summarize(perc = mean(pred_median > cum_diff))
m %>% summarize(perc = mean(pred_median >= cum_diff))
m %>% summarize(perc = mean(pred_median <= cum_diff))
m %>% summarize(perc = mean(pred_median - cum_diff))
m %>% summarize(perc = median(pred_median - cum_diff))
m %>% mutate(perc = pred_median - cum_diff) %>% qplot(perc, data = ., geom = "histogram")
m %>% mutate(perc = pred_median - cum_diff) %>% qplot(perc, data = ., geom = "histogram", bins = 50)
