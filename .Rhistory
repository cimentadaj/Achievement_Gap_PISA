# "Russia"
)
temp_dir <- tempdir()
url <- "http://vs-web-fs-1.oecd.org/pisa/PUF_SPSS_COMBINED_CMB_SCH_QQQ.zip"
dir_pisa <- file.path(temp_dir, "pisa_school.zip")
download.file(url, destfile = dir_pisa)
unzip(dir_pisa, exdir = temp_dir)
school2015 <- read_spss(file.path(temp_dir, "CY6_MS_CMB_SCH_QQQ.sav"))
school_vars <- c(
"SC03Q01",
"SC03Q01",
"SC02Q01",
"SC02Q01",
"SC01Q01",
"SC013Q01TA"
)
school_data <- list(
school2000,
school2003,
school2006,
school2009,
school2012,
school2015
)
key <- c(rep("SCHOOLID", 5), "CNTSCHID")
sapply(adapted_year_data, ncol)
school_data_ready <-
pmap(list(school_data, key, school_vars), function(x, y, z) {
select_(x, y, z)
})
key[1]
attempt <- pmap(list(adapted_year_data, school_data_ready, key), function(x, y, z) {
left_join(select_(x, z), y, by = z)
})
attempt <- pmap(list(adapted_year_data, school_data_ready, key), function(x, y, z) {
left_join(select_(x, z, "PVNUM1"), y, by = z)
})
dim(adapted_year_data[[1]])
head(adapted_year_data[[1]])
head(complete_data_topbottom[1:5])
nrow(complete_data_topbottom)
cimentadaj::describe(complete_data_topbottom)
complete_data_topbottom
describe(school_data_ready[[1]])
school_data_ready[[1]][1:100, ]
school_data_ready[[1]][1:10, ]
names(school2015)
unique(school2015$CNT)
unique(school2015$CNTRYID)
pisa_countrynames[school2015$CNT]
unique(pisa_countrynames[school2015$CNT])
pisa_countrynames[school2015$CNT]
tail(pisa_countrynames[school2015$CNT])
unique(school2015$CNT)
pisa_countrynames[school2015$CNT]
sapply(school_data, function(x) CNT %IN% names(x))
sapply(school_data, function(x) CNT %in% names(x))
sapply(school_data, function(x) "CNT" %in% names(x))
years
school_data_ready <-
pmap(list(school_data, key, school_vars, years), function(data, key_var, selected, year) {
data %>%
mutate(country = pisa_countrynames[CNT],
year = year) %>%
select_(key_var, selected, "year", "country")
})
describe(school_data_ready[[1]])
head(school_data_ready[[1]])
lapply(school_data_ready, function(x) unique(x[[2]]))
school_data_ready <-
pmap(list(school_data, key, school_vars, years), function(data, key_var, selected, year) {
data %>%
mutate_(private_public = as.character(selected))
mutate(country = pisa_countrynames[CNT],
year = year) %>%
select_(key_var, private_public, "year", "country")
})
school_data_ready <-
pmap(list(school_data, key, school_vars, years), function(data, key_var, selected, year) {
data %>%
mutate_(private_public = as.character(selected)) %>%
mutate(country = pisa_countrynames[CNT],
year = year) %>%
select_(key_var, private_public, "year", "country")
})
school_data_ready <-
pmap(list(school_data, key, school_vars, years), function(data, key_var, selected, year) {
data %>%
mutate_("private_public" = as.character(selected)) %>%
mutate(country = pisa_countrynames[CNT],
year = year) %>%
select_(key_var, private_public, "year", "country")
})
school_data_ready <-
pmap(list(school_data, key, school_vars, years), function(data, key_var, selected, year) {
data %>%
mutate(country = pisa_countrynames[CNT],
year = year) %>%
select_(key_var, selected, private_public, "year", "country")
})
school_data_ready <-
pmap(list(school_data, key, school_vars, years), function(data, key_var, selected, year) {
data %>%
mutate(country = pisa_countrynames[CNT],
year = year) %>%
select_(key_var, selected, "year", "country")
})
school_data_ready %>%
enframe() %>%
unnest() %>%
as_tibble()
lapply(school_data_ready, function(x) {
sapply(x, class)
})
school_data_ready %>%
enframe() %>%
unnest()
?sweep
?Map
school_data_ready[[1]][1]
school_data_ready[[1]][ ,1]
lapply(school_data_ready, function(x) {
sapply(x, class)
})
school_data_ready <- lapply(school_data_ready, function(data) {
data[, 1] <- as.numeric(data[, 1])
data[, 2] <- as.character(data[, 2])
data
})
school_data_ready <- lapply(school_data_ready, function(data) {
data[, 1] <- as.numeric(as.character(data[, 1]))
data[, 2] <- as.character(data[, 2])
data
})
school_data_ready %>%
enframe() %>%
unnest() %>%
as_tibble()
school_data_ready <-
pmap(list(school_data, key, school_vars, years), function(data, key_var, selected, year) {
data %>%
mutate(country = pisa_countrynames[CNT],
year = year) %>%
select_(key_var, selected, "year", "country")
})
lapply(school_data_ready, head)
school_data_ready <- lapply(school_data_ready, function(data) {
data[, 1] <- as.numeric(as.character(data[, 1]))
data[, 2] <- as.character(data[, 2])
names(data)[2] <- "private_public"
data
})
school_data_ready %>%
enframe() %>%
unnest() %>%
as_tibble()
lapply(school_data_ready, head)
school_data_ready <-
pmap(list(school_data, key, school_vars, years), function(data, key_var, selected, year) {
data %>%
mutate(country = pisa_countrynames[CNT],
year = year) %>%
select_(key_var, selected, "year", "country")
})
lapply(school_data_ready, head)
school_data_ready <-
pmap(list(school_data, key, school_vars, years), function(data, key_var, selected, year) {
data %>%
mutate(country = pisa_countrynames[CNT],
year = year) %>%
select_(key_var, selected, "year", "country")
})
school_data_ready <- lapply(school_data_ready, function(data) {
data[, 1] <- as.numeric(as.character(data[, 1]))
data[, 2] <- as.character(data[, 2])
names(data)[1] <- "school_id"
names(data)[2] <- "private_public"
data
})
school_data_ready %>%
enframe() %>%
unnest() %>%
as_tibble()
school_data_ready %>%
enframe() %>%
unnest() %>%
as_tibble() %>%
count(country, year, private_public)
m <- school_data_ready %>%
enframe() %>%
unnest() %>%
as_tibble()
m$private_public
unique(m$private_public)
school_data_ready <-
pmap(list(school_data, key, school_vars, years), function(data, key_var, selected, year) {
data %>%
mutate(country = pisa_countrynames[CNT],
year = year) %>%
select_(key_var, selected, "year", "country")
})
school_data_ready[1:5, 1:5]
school_data_ready[[6]][1:5, 1:5]
school_data_ready[[6]][1:5, ]
as.character(school_data_ready[[6]]$SC013Q01TA)
for(i in 1:6) print(class(as.character(school_data_ready[[i]]$SC013Q01TA)))
school_data_ready <-
pmap(list(school_data, key, school_vars, years), function(data, key_var, selected, year) {
data %>%
mutate(country = pisa_countrynames[CNT],
year = year) %>%
select_(key_var, selected, "year", "country")
})
school_data_ready <- lapply(school_data_ready, function(data) {
data[, 1] <- as.numeric(as.character(data[, 1]))
data[, 2] <- as.character(data[, 2])
names(data)[1] <- "school_id"
names(data)[2] <- "private_public"
data
})
school_data_ready %>%
enframe() %>%
unnest() %>%
as_tibble() %>%
count(country, year, private_public)
school_data_ready <-
pmap(list(school_data, key, school_vars, years), function(data, key_var, selected, year) {
data %>%
mutate(country = pisa_countrynames[CNT],
year = year) %>%
select_(key_var, selected, "year", "country")
})
lapply(school_data_ready, head)
lapply(school_data_ready, function(x) unique(x[, 2]))
lapply(school_data_ready, function(x) unique(x[[, 2]]))
lapply(school_data_ready, function(x) unique(x[[2]]))
lapply(school_data_ready, function(x) as.character(x[[2]]))
lapply(school_data_ready, function(x) as.character(x[[2]])[1:50])
lapply(school_data_ready, function(x) unique(x[[2]]))
school_data_ready <- lapply(school_data_ready, function(data) {
data[, 1] <- as.numeric(as.character(data[, 1]))
data[, 2] <- as.character(data[, 2])
names(data)[1] <- "school_id"
names(data)[2] <- "private_public"
data
})
?recode
?dplyr::recode
m <- school_data_ready %>%
enframe() %>%
unnest() %>%
as_tibble()
unique(m$private_public)
m <- school_data_ready %>%
enframe() %>%
unnest() %>%
as_tibble() %>%
mutate(private_public = dplyr::recode(private_public,
'1' = "public",
'2' = "private",
'Public' = 'public',
'Private' ='private'))
unique(m$private_public)
school_data_ready %>%
enframe() %>%
unnest() %>%
as_tibble() %>%
mutate(private_public = dplyr::recode(private_public,
'1' = "public",
'2' = "private",
'Public' = 'public',
'Private' ='private',
'NA' = NA))
school_data_ready %>%
enframe() %>%
unnest() %>%
as_tibble() %>%
mutate(private_public = dplyr::recode(private_public,
'1' = "public",
'2' = "private",
'Public' = 'public',
'Private' ='private'))
m <- school_data_ready %>%
enframe() %>%
unnest() %>%
as_tibble() %>%
mutate(private_public = dplyr::recode(private_public,
'1' = "public",
'2' = "private",
'Public' = 'public',
'Private' ='private'))
m
unique(m$private_public)
school_data_ready <-
pmap(list(school_data, key, school_vars, years), function(data, key_var, selected, year) {
data %>%
mutate(country = pisa_countrynames[CNT],
year = year) %>%
select_(key_var, selected, "year", "country")
})
school_data_ready <- lapply(school_data_ready, function(data) {
names(data)[1] <- "school_id"
names(data)[2] <- "private_public"
data$school_id <- as.numeric(as.character(data$school_id))
data$private_public <- as.character(data$private_public)
data
})
m <- school_data_ready %>%
enframe() %>%
unnest() %>%
as_tibble() %>%
mutate(private_public = dplyr::recode(private_public,
'1' = "public",
'2' = "private",
'Public' = 'public',
'Private' ='private'))
unique(m$private_public)
school_data_ready %>%
enframe() %>%
unnest() %>%
as_tibble() %>%
mutate(private_public = dplyr::recode(private_public,
'1' = "public",
'2' = "private",
'Public' = 'public',
'Private' ='private')) %>%
count(country, year, private_public)
school_data_ready %>%
enframe() %>%
unnest() %>%
as_tibble() %>%
mutate(private_public = dplyr::recode(private_public,
'1' = "public",
'2' = "private",
'Public' = 'public',
'Private' ='private'))
school_data_ready %>%
enframe() %>%
unnest() %>%
as_tibble() %>%
mutate(private_public = dplyr::recode(private_public,
'1' = "public",
'2' = "private",
'Public' = 'public',
'Private' ='private')) %>%
count(country, as.character(year), private_public)
?count
school_data_ready %>%
enframe() %>%
unnest() %>%
as_tibble() %>%
mutate(private_public = dplyr::recode(private_public,
'1' = "public",
'2' = "private",
'Public' = 'public',
'Private' ='private')) %>%
dplyr::count(country, year, private_public)
school_data_ready %>%
enframe() %>%
unnest() %>%
as_tibble() %>%
mutate(private_public = dplyr::recode(private_public,
'1' = "public",
'2' = "private",
'Public' = 'public',
'Private' ='private')) %>%
group_by(country, year, private_public) %>%
summarize(n = n())
school_data_ready %>%
enframe() %>%
unnest() %>%
as_tibble() %>%
mutate(private_public = dplyr::recode(private_public,
'1' = "public",
'2' = "private",
'Public' = 'public',
'Private' ='private')) %>%
group_by(country, year, private_public) %>%
summarize(n = n())
school_data_ready %>%
enframe() %>%
unnest() %>%
as_tibble() %>%
mutate(private_public = dplyr::recode(private_public,
'1' = "public",
'2' = "private",
'Public' = 'public',
'Private' ='private')) %>%
group_by(country, year, private_public) %>%
summarize(n = n()) %>%
filter(!is.na(private_public))
school_data_ready %>%
enframe() %>%
unnest() %>%
as_tibble() %>%
mutate(private_public = dplyr::recode(private_public,
'1' = "public",
'2' = "private",
'Public' = 'public',
'Private' ='private')) %>%
group_by(country, year, private_public) %>%
summarize(n = n()) %>%
filter(!is.na(private_public)) %>%
group_by(country, year) %>%
mutate(n_total = n())
school_data_ready %>%
enframe() %>%
unnest() %>%
as_tibble() %>%
mutate(private_public = dplyr::recode(private_public,
'1' = "public",
'2' = "private",
'Public' = 'public',
'Private' ='private')) %>%
group_by(country, year, private_public) %>%
summarize(n = n()) %>%
filter(!is.na(private_public)) %>%
mutate(total = sum(n),
total_perc = n / total * 100)
school_data_ready %>%
enframe() %>%
unnest() %>%
as_tibble() %>%
mutate(private_public = dplyr::recode(private_public,
'1' = "public",
'2' = "private",
'Public' = 'public',
'Private' ='private')) %>%
group_by(country, year, private_public) %>%
summarize(n = n()) %>%
filter(!is.na(private_public)) %>%
mutate(total = sum(n),
total_perc = round(n / total * 100), 2)
school_data_ready %>%
enframe() %>%
unnest() %>%
as_tibble() %>%
mutate(private_public = dplyr::recode(private_public,
'1' = "public",
'2' = "private",
'Public' = 'public',
'Private' ='private')) %>%
group_by(country, year, private_public) %>%
summarize(n = n()) %>%
filter(!is.na(private_public)) %>%
mutate(total = sum(n),
total_perc = round(n / total * 100, 2))
school_data_ready %>%
enframe() %>%
unnest() %>%
as_tibble() %>%
mutate(private_public = dplyr::recode(private_public,
'1' = "public",
'2' = "private",
'Public' = 'public',
'Private' ='private')) %>%
group_by(country, year, private_public) %>%
summarize(n = n()) %>%
filter(!is.na(private_public)) %>%
mutate(total = sum(n),
total_perc = round(n / total * 100, 2)) %>%
ggplot(aes(year, total_perc, group = private_public, color = private_public)) +
geom_line()
school_data_ready %>%
enframe() %>%
unnest() %>%
as_tibble() %>%
mutate(private_public = dplyr::recode(private_public,
'1' = "public",
'2' = "private",
'Public' = 'public',
'Private' ='private')) %>%
group_by(country, year, private_public) %>%
summarize(n = n()) %>%
filter(!is.na(private_public)) %>%
mutate(total = sum(n),
total_perc = round(n / total * 100, 2))
school_data_ready %>%
enframe() %>%
unnest() %>%
as_tibble() %>%
mutate(private_public = dplyr::recode(private_public,
'1' = "public",
'2' = "private",
'Public' = 'public',
'Private' ='private')) %>%
group_by(country, year, private_public) %>%
summarize(n = n()) %>%
filter(!is.na(private_public)) %>%
mutate(total = sum(n),
total_perc = round(n / total * 100, 2)) %>%
ggplot(aes(year, total_perc, group = private_public, color = private_public)) +
geom_line() +
facet_wrap(~ country)
school_data_ready %>%
enframe() %>%
unnest() %>%
as_tibble() %>%
mutate(private_public = dplyr::recode(private_public,
'1' = "public",
'2' = "private",
'Public' = 'public',
'Private' ='private')) %>%
group_by(country, year, private_public) %>%
summarize(n = n()) %>%
filter(!is.na(private_public)) %>%
mutate(total = sum(n),
total_perc = round(n / total * 100, 2)) %>%
filter(country %in% countries) %>%
ggplot(aes(year, total_perc, group = private_public, color = private_public)) +
geom_line() +
facet_wrap(~ country)
